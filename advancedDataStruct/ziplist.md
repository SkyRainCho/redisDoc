# Redis中压缩链表的实现
前面我们已经介绍了*Redis*中所实现的经典双端链表了，而这种链表存在一个问题，便是在存储小数据的时候，
内存使用效率过低，例如当一个链表节点中只保存一个字节的`unsigned char`数据时，我们需要为这个节点保存24个字节的额外数据，
其中包含`listNode.prev`指针，`listNode.next`指针，以及指向具体数据的`listNode.value`指针，
同时对于链表节点所占用内存的反复申请与释放，也容易导致内存碎片的产生。
为了解决经典双端链表在保存小数据而导致内存效率过低的问题，*Redis*设了一套压缩链表的数据数据结构*ziplist*来对这种场景下的链表应用进行优化。

## 压缩链表概述
压缩链表是一种专门为了提升内存使用效率而设计的，经过特殊编码的双端链表数据结构。
既可以用来保存整形数值，也可以用来保存字符串数值，为了节约内存，同时也是体现压缩之含义，
当保存一个整形数值时，压缩链表会使用一个真正的整形数来保存，而不是使用字符串的形式来存储。
这一点很容易理解，一个整数可以根据其数值的大小使用1个字节，2个字节，4个字节或者8个字节来表示，
如果使用字符串的形式来存储的话，其所需的字节数大小一定不小于使用整形数所需的字节数。

压缩链表允许在链表两端以*O(1)*的时间复杂度执行*Pop*或者*Push*操作，当然这只是一种理想状态下的情况，
由于压缩链表实际上是内存中一段连续分配的内存，因此这些操作需要对压缩链表所使用的内存进行重新分配，
所以其真实的时间复杂度是和链表所使用的内存大小相关的。

### 压缩链表的内存分布

压缩链表与经典双端链表最大的区别在于，双端链表的节点是分散在内存中并不是连续的，压缩链表中所有的数据都是存储在一段连续的内存之中的，
![压缩链表内存分布](https://machiavelli-1301806039.cos.ap-beijing.myqcloud.com/%E5%8E%8B%E7%BC%A9%E9%93%BE%E8%A1%A8%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83.PNG)

上图便是*Redis*中一个压缩链表在内存之中的分布情况，本质上，压缩链表并没有一个专门的数据结构用于描述它，所有的相关操作都是通过指针与解码出来的偏移进行的。
在分配给压缩链表的内存中，有几个字段用于描述压缩链表的长度信息与结束标记，其中
- `<zlbytes>`，该字段固定是一个四字节的无符号整数，用于表示整个压缩链表所占用内存的长度（以字节为单位），这个长度数值是包含这个`<zlbytes>`本身的。
- `<ztail>`，该字段固定是一个四字节的无符号整数，用于表示在链表中最后一个节点的偏移字节量，借助这个字段，我们不需要遍历整个链表便可以在链表尾部执行*Pop*操作。
- `<zllen>`，该字段固定是一个两个字节的无符号整数，用于表示链表中节点的个数。但是该字段最多只能表示`2^16-2`个节点个数；超过这个数量，也就是该字段被设置为`2^16-1`时，
意味着我们需要遍历整个链表，才可以获取链表中节点真实的数量。
- `<entry>`，该字段表示链表中的一个节点，同一个链表中的节点，其长度大概率是不同的，因此需要特殊的方式来获取节点的长度，具体的内容会在下一个部分详细介绍。
- `<zlend>`，该字段可以被认为是一个特殊的`<entry>`节点，用作压缩链表的结束标记，只有一个字节，存储着`0xFF`，一旦我们遍历到这个特殊的标记，便意味着我们完成了对这个压缩链表的遍历。

### 链表结点的内存分布

在压缩链表中每一个节点数据在其前缀都包含着两个对于节点而言重要的数据信息，
- `<prevlen>`，这个字段标记了该节点的前序节点的长度，以便我们可以向链表的头部反向遍历链表，这个字段的编码格式有两种：
    1. 当前节点的前序节点的长度为0到253个字节时，`<prevlen>`字段只需要一个8位的无符号整数，便可以编码对应的长度。
    2. 当前节点的前序节点的长度大于等于254个字节时，`<prevlen>`字段则需要5个字节，其中第一个字节会被设置成`0xFE`也就是254，
    这是一个特殊标记，用于表明，这里保存了一个比较大的数值，需要继续读取后续的4个字节以解码出前序节点的长度。
    而为什么不选择`0xFF`作为特殊标记的原因在于，`0xFF`是整个链表结束的标记。
- `<encoding>`

### 压缩链表与双端链表的对比

## 压缩链表的基础操作

## 压缩链表的用户接口

***
![公众号二维码](https://machiavelli-1301806039.cos.ap-beijing.myqcloud.com/qrcode_for_gh_836beef2355a_344.jpg)

喜欢的同学可以扫描二维码，关注我的微信公众号，*马基雅维利incoding*